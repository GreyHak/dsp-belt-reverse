//
// Copyright (c) 2021, Aaron Shumate
// All rights reserved.
//
// This source code is licensed under the BSD-style license found in the
// LICENSE.txt file in the root directory of this source tree. 
//
// Dyson Sphere Program is developed by Youthcat Studio and published by Gamera Game.

using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using BepInEx;
using HarmonyLib;
using UnityEngine;
using UnityEngine.UI;
using System.IO;
using BepInEx.Logging;
using System.Security;
using System.Security.Permissions;

[module: UnverifiableCode]
#pragma warning disable CS0618 // Type or member is obsolete
[assembly: SecurityPermission(SecurityAction.RequestMinimum, SkipVerification = true)]
#pragma warning restore CS0618 // Type or member is obsolete
namespace DSPBeltReverseDirection
{
    [BepInPlugin(pluginGuid, pluginName, pluginVersion)]
    [BepInProcess("DSPGAME.exe")]
    public class DSPBeltReverseDirection : BaseUnityPlugin
    {
        public const string pluginGuid = "greyhak.dysonsphereprogram.beltreversedirection";
        public const string pluginName = "DSP Belt Reverse Direction";
        public const string pluginVersion = "1.0.0";
        new internal static ManualLogSource Logger;
        new internal static BepInEx.Configuration.ConfigFile Config;
        Harmony harmony;

        public void Awake()
        {
            Logger = base.Logger;  // "C:\Program Files (x86)\Steam\steamapps\common\Dyson Sphere Program\BepInEx\LogOutput.log"
            Config = base.Config;  // "C:\Program Files (x86)\Steam\steamapps\common\Dyson Sphere Program\BepInEx\config\greyhak.dysonsphereprogram.beltreversedirection.cfg"

            harmony = new Harmony(pluginGuid);
            harmony.PatchAll(typeof(DSPBeltReverseDirection));

            Logger.LogInfo("Initialization complete.");
        }

        public static RectTransform reverseButton;
        public static Sprite reverseSprite;

        // The first call happens for some reason after every game load.
        // This causes the tip to be displayed without a mouse-over when the BeltWindow opens for the first time.
        static bool ignoreFirstReverseButtonOnPointerEnter = true;

        [HarmonyPrefix, HarmonyPatch(typeof(UIButton), "OnPointerEnter")]
        public static bool UIButton_OnPointerEnter_Prefix(UIButton __instance)
        {
            if (reverseButton != null && __instance == reverseButton.GetComponent<UIButton>() && ignoreFirstReverseButtonOnPointerEnter)
            {
                ignoreFirstReverseButtonOnPointerEnter = false;
                return false;
            }
            return true;
        }

        [HarmonyPrefix, HarmonyPatch(typeof(GameMain), "Begin")]
        public static void GameMain_Begin_Prefix()
        {
            ignoreFirstReverseButtonOnPointerEnter = true;
            if (GameMain.instance != null && GameObject.Find("Game Menu/button-1-bg"))
            {
                if (!GameObject.Find("greyhak-reverse-button"))
                {
                    RectTransform prefab = GameObject.Find("Game Menu/button-1-bg").GetComponent<RectTransform>();
                    Vector3 referencePosition = prefab.localPosition;
                    reverseButton = GameObject.Instantiate<RectTransform>(prefab);
                    reverseButton.gameObject.name = "greyhak-reverse-button";
                    UIButton uiButton = reverseButton.GetComponent<UIButton>();
                    uiButton.tips.tipTitle = "Reverse Belt Direction";
                    uiButton.tips.tipText = "Click to reverse the direction of the conveyer belt.";
                    uiButton.tips.delay = 0f;
                    reverseButton.transform.Find("button-1/icon").GetComponent<Image>().sprite = GetSprite();
                    reverseButton.SetParent(UIRoot.instance.uiGame.beltWindow.windowTrans);
                    reverseButton.localScale = new Vector3(0.5f, 0.5f, 0.5f);
                    reverseButton.localPosition = new Vector3(66, -60, 0);
                    uiButton.OnPointerDown(null);
                    uiButton.OnPointerEnter(null);
                    uiButton.button.onClick.AddListener(() =>
                    {
                        PrintData();
                        ReverseBelt(UIRoot.instance.uiGame.beltWindow.beltId);
                    });

                }
            }
        }

        public static Sprite GetSprite()
        {
            Texture2D tex = new Texture2D(48, 48, TextureFormat.RGBA32, false);
            Color color = new Color(1, 1, 1, 1);

            // Draw a plane like the one re[resending drones in the Mecha Panel...
            for (int x = 0; x < 48; x++)
            {
                for (int y = 0; y < 48; y++)
                {
                    if (((x >= 7) && (x <= 39) && (y >= 10) && (y <= 16)) ||  // top
                        ((x == 33) && (y >= 1) && (y <= 25)) ||
                        ((x == 34) && (y >= 2) && (y <= 24)) ||
                        ((x == 35) && (y >= 3) && (y <= 23)) ||
                        ((x == 36) && (y >= 4) && (y <= 22)) ||
                        ((x == 37) && (y >= 5) && (y <= 21)) ||
                        ((x == 38) && (y >= 6) && (y <= 20)) ||
                        ((x == 39) && (y >= 7) && (y <= 19)) ||
                        ((x == 40) && (y >= 8) && (y <= 18)) ||
                        ((x == 41) && (y >= 9) && (y <= 17)) ||
                        ((x == 42) && (y >= 10) && (y <= 16)) ||
                        ((x == 43) && (y >= 11) && (y <= 15)) ||
                        ((x == 44) && (y >= 12) && (y <= 14)) ||
                        ((x == 45) && (y == 13)) ||
                        ((x >= 8) && (x <= 40) && (y >= 31) && (y <= 37)) ||  // bottom
                        ((x == 2) && (y == 34)) ||
                        ((x == 3) && (y >= 33) && (y <= 35)) ||
                        ((x == 4) && (y >= 32) && (y <= 36)) ||
                        ((x == 5) && (y >= 31) && (y <= 37)) ||
                        ((x == 6) && (y >= 30) && (y <= 38)) ||
                        ((x == 7) && (y >= 29) && (y <= 39)) ||
                        ((x == 8) && (y >= 28) && (y <= 40)) ||
                        ((x == 9) && (y >= 27) && (y <= 41)) ||
                        ((x == 10) && (y >= 26) && (y <= 42)) ||
                        ((x == 11) && (y >= 25) && (y <= 43)) ||
                        ((x == 12) && (y >= 24) && (y <= 44)) ||
                        ((x == 13) && (y >= 23) && (y <= 45)) ||
                        ((x == 14) && (y >= 22) && (y <= 46)))
                    {
                        tex.SetPixel(x, y, color);
                    }
                    else
                    {
                        tex.SetPixel(x, y, new Color(0, 0, 0, 0));
                    }
                }
            }

            tex.name = "greyhak-reverse-icon";
            tex.Apply();

            return Sprite.Create(tex, new Rect(0f, 0f, 48f, 48f), new Vector2(0f, 0f), 1000);
        }

        static void PrintData()
        {
            Logger.LogWarning("--------------------------------------------------------");
            if (GameMain.mainPlayer.factory.cargoTraffic != null)
            {
                if (GameMain.mainPlayer.factory.cargoTraffic.pathPool != null)
                {
                    foreach (CargoPath cargoPath in GameMain.mainPlayer.factory.cargoTraffic.pathPool)
                    {
                        if (cargoPath != null && cargoPath.id != 0)
                        {
                            Logger.LogWarning("cargoPath.id=" + cargoPath.id.ToString());
                            foreach (int belt in cargoPath.belts)
                            {
                                Logger.LogWarning("   belt=" + belt.ToString());
                            }
                        }
                    }
                }

                if (GameMain.mainPlayer.factory.cargoTraffic.beltPool != null)
                {
                    Logger.LogWarning("++++++++++++++++++++++++++++++++++++++++++++++++++++++++");
                    foreach (BeltComponent beltComponent in GameMain.mainPlayer.factory.cargoTraffic.beltPool)
                    {
                        if (beltComponent.id != 0)
                        {
                            EntityData entityData = GameMain.mainPlayer.factory.entityPool[beltComponent.entityId];
                            CargoPath cargoPath = GameMain.mainPlayer.factory.cargoTraffic.pathPool[beltComponent.segPathId];
                            Logger.LogWarning(
                                "beltComponent.id=" + beltComponent.id.ToString() +
                                ", beltComponent.entityId=" + beltComponent.entityId.ToString() +
                                ", entityData.pos=" + entityData.pos.ToString() +
                                ", entityData.rot=" + entityData.rot.ToString() +
                                ", beltComponent.outputId=" + beltComponent.outputId.ToString() +  // If this is another belt, but this belt is the last in the beltPool, then this path is dumping into anther path.
                                ", beltComponent.backInputId=" + beltComponent.backInputId.ToString() +
                                ", beltComponent.leftInputId=" + beltComponent.leftInputId.ToString() +  // This is probably another dump in case
                                ", beltComponent.rightInputId=" + beltComponent.rightInputId.ToString() + // *** If this isn't zero, (and is a belt), then another path is dumping into this one
                                ", beltComponent.segIndex=" + beltComponent.segIndex.ToString() +
                                ", beltComponent.segLength=" + beltComponent.segLength.ToString() +
                                ", beltComponent.segPathId=" + beltComponent.segPathId.ToString() +
                                ", beltComponent.segPivotOffset=" + beltComponent.segPivotOffset.ToString() +
                                ", cargoPath.id=" + cargoPath.id.ToString() +
                                ", cargoPath.pathLength=" + cargoPath.pathLength.ToString() +
                                ", cargoPath.cargoContainer=" + (cargoPath.cargoContainer == null ? "null" : "valid")/* +
                                ", entityData.splitterId=" + entityData.splitterId.ToString() +
                                ", entityData.minerId=" + entityData.minerId.ToString() +
                                ", entityData.tankId=" + entityData.tankId.ToString() +
                                ", entityData.fractionateId=" + entityData.fractionateId.ToString() +
                                ", entityData.powerExcId=" + entityData.powerExcId.ToString()*/);

                            // Machine outputing: Shows on first belt in slot 1 
                            // Machine inputing:  Shows on last  belt in slot 0
                            // Miner is the only one that can't be inverted
                            bool flag2;  // Looks like 0 is always True and 1 is always False
                            int entityIdOfMachineGettingInput;
                            int machineSlot;
                            GameMain.mainPlayer.factory.ReadObjectConn(beltComponent.entityId, 0, out flag2, out entityIdOfMachineGettingInput, out machineSlot);
                            if (entityIdOfMachineGettingInput > 0)  // Machine input, connected to last belt
                            {
                                Logger.LogInfo("   [0] flag2=" + flag2.ToString() + ", entityIdOfMachineGettingInput=" + entityIdOfMachineGettingInput.ToString() + ", machineSlot=" + machineSlot.ToString());
                                EntityData entity2 = GameMain.mainPlayer.factory.entityPool[entityIdOfMachineGettingInput];
                                if (entity2.splitterId != 0)
                                    Logger.LogInfo("      entity2.splitterId=" + entity2.splitterId.ToString());
                                if (entity2.minerId != 0)
                                    Logger.LogInfo("      entity2.minerId=" + entity2.minerId.ToString());
                                if (entity2.tankId != 0)
                                    Logger.LogInfo("      entity2.tankId=" + entity2.tankId.ToString());
                                if (entity2.fractionateId != 0)
                                    Logger.LogInfo("      entity2.fractionateId=" + entity2.fractionateId.ToString());
                                if (entity2.powerExcId != 0)
                                    Logger.LogInfo("      entity2.powerExcId=" + entity2.powerExcId.ToString());
                            }
                            int entityIdOfMachineOutputting;
                            GameMain.mainPlayer.factory.ReadObjectConn(beltComponent.entityId, 1, out flag2, out entityIdOfMachineOutputting, out machineSlot);
                            if (entityIdOfMachineOutputting > 0)  // Machine output, connected to first belt
                            {
                                Logger.LogInfo("   [1] flag2=" + flag2.ToString() + ", entityIdOfMachineOutputting=" + entityIdOfMachineOutputting.ToString() + ", machineSlot=" + machineSlot.ToString());
                                EntityData entity3 = GameMain.mainPlayer.factory.entityPool[entityIdOfMachineOutputting];
                                if (entity3.splitterId != 0)
                                    Logger.LogInfo("      entity3.splitterId=" + entity3.splitterId.ToString());
                                if (entity3.minerId != 0)
                                    Logger.LogInfo("      entity3.minerId=" + entity3.minerId.ToString());
                                if (entity3.tankId != 0)
                                    Logger.LogInfo("      entity3.tankId=" + entity3.tankId.ToString());
                                if (entity3.fractionateId != 0)
                                    Logger.LogInfo("      entity3.fractionateId=" + entity3.fractionateId.ToString());
                                if (entity3.powerExcId != 0)
                                    Logger.LogInfo("      entity3.powerExcId=" + entity3.powerExcId.ToString());
                            }
                        }
                    }
                }
            }
        }

        struct ReverseConnection
        {
            public int targetId;
            public int outputId;
            public int inputId0;
            public int inputId1;
            public int inputId2;
        }

        static void ReverseBelt(int beltId)
        {
            PlanetFactory factory = GameMain.mainPlayer.factory;
            ref CargoTraffic cargoTraffic = ref factory.cargoTraffic;
            ref BeltComponent beltComponent = ref cargoTraffic.beltPool[beltId];
            ref CargoPath cargoPath = ref cargoTraffic.pathPool[beltComponent.segPathId];

            if (cargoPath.belts.Count > 1)
            {
                Logger.LogWarning("Reverse!");

                int firstBeltId = cargoPath.belts[0];
                int lastBeltId = cargoPath.belts[cargoPath.belts.Count - 1];
                BeltComponent firstBelt = cargoTraffic.beltPool[firstBeltId];
                BeltComponent lastBelt = cargoTraffic.beltPool[lastBeltId];

                // For machine connections we reference PlanetFactory.CreateEntityLogicComponents
                // These include splitter, miner, tank, fractionate, powerExchanger (and station)
                bool unusedFlag;
                int entityIdOfMachineOutputting;
                int slotOfMachineOutputting;
                int entityIdOfMachineGettingInput;
                int slotOfMachineGettingInput;
                factory.ReadObjectConn(firstBelt.entityId, 1, out unusedFlag, out entityIdOfMachineOutputting, out slotOfMachineOutputting);
                factory.ReadObjectConn(lastBelt.entityId, 0, out unusedFlag, out entityIdOfMachineGettingInput, out slotOfMachineGettingInput);
                // Note: "Machine" at this point is likely to just be another conveyer.

                List<ReverseConnection> reverseConnections = new List<ReverseConnection>();
                for (int beltIdx = cargoPath.belts.Count - 1; beltIdx >= 0; --beltIdx)
                {
                    BeltComponent thisBelt;
                    thisBelt = cargoTraffic.beltPool[cargoPath.belts[beltIdx]];
                    Logger.LogInfo((beltIdx > 0 ? cargoTraffic.beltPool[cargoPath.belts[beltIdx - 1]].id.ToString() : "start") + " -> " + thisBelt.id.ToString() + " -> " + (beltIdx + 1 < cargoPath.belts.Count ? cargoTraffic.beltPool[cargoPath.belts[beltIdx + 1]].id.ToString() : "end"));
                    Logger.LogInfo("   outputId=" + thisBelt.outputId.ToString() + ", backInputId=" + thisBelt.backInputId.ToString() + ", leftInputId=" + thisBelt.leftInputId.ToString() + ", rightInputId=" + thisBelt.rightInputId.ToString());

                    ReverseConnection reverseConnection = new ReverseConnection();
                    reverseConnection.targetId = thisBelt.id;
                    if (beltIdx > 0)
                        reverseConnection.outputId = cargoTraffic.beltPool[cargoPath.belts[beltIdx - 1]].id;
                    else if (thisBelt.backInputId != 0)
                        reverseConnection.outputId = thisBelt.backInputId;
                    else if (thisBelt.leftInputId != 0)
                        reverseConnection.outputId = thisBelt.leftInputId;
                    else if (thisBelt.rightInputId != 0)
                        reverseConnection.outputId = thisBelt.rightInputId;
                    Logger.LogInfo("      targetId=" + reverseConnection.targetId.ToString() + ", outputId=" + reverseConnection.outputId.ToString());

                    List<int> inputs = new List<int>();
                    if (thisBelt.outputId != 0) inputs.Add(thisBelt.outputId);
                    if (thisBelt.backInputId != 0 && thisBelt.backInputId != reverseConnection.outputId) inputs.Add(thisBelt.backInputId);
                    if (thisBelt.leftInputId != 0 && thisBelt.leftInputId != reverseConnection.outputId) inputs.Add(thisBelt.leftInputId);
                    if (thisBelt.rightInputId != 0 && thisBelt.rightInputId != reverseConnection.outputId) inputs.Add(thisBelt.rightInputId);
                    if (inputs.Count > 0) reverseConnection.inputId0 = inputs[0];
                    if (inputs.Count > 1) reverseConnection.inputId1 = inputs[1];
                    if (inputs.Count > 2) reverseConnection.inputId2 = inputs[2];
                    Logger.LogInfo("      inputId0=" + reverseConnection.inputId0.ToString() + ", inputId1=" + reverseConnection.inputId1.ToString() + ", inputId2=" + reverseConnection.inputId2.ToString());

                    reverseConnections.Add(reverseConnection);
                }

                // The order of this loop can be swaped, and still performs the same change.
                foreach (ReverseConnection reverseConnection in reverseConnections)
                {
                    cargoTraffic.AlterBeltConnections(reverseConnection.targetId, reverseConnection.outputId, reverseConnection.inputId0, reverseConnection.inputId1, reverseConnection.inputId2);
                }

                if (entityIdOfMachineOutputting > 0)
                {
                    EntityData entityOfMachineOutputting = factory.entityPool[entityIdOfMachineOutputting];
                    if (entityOfMachineOutputting.splitterId != 0)
                    {
                        //Logger.LogInfo("      Belt receiving input from splitter " + entityOfMachineOutputting.splitterId.ToString());
                        cargoTraffic.ConnectToSplitter(entityOfMachineOutputting.splitterId, lastBeltId, slotOfMachineOutputting, true);
                    }
                    if (entityOfMachineOutputting.minerId != 0)
                    {
                        //Logger.LogInfo("      Belt receiving input from miner " + entityOfMachineOutputting.minerId.ToString());
                        factory.factorySystem.SetMinerInsertTarget(entityOfMachineOutputting.minerId, 0);
                    }
                    if (entityOfMachineOutputting.tankId != 0)
                    {
                        //Logger.LogInfo("      Belt receiving input from tank " + entityOfMachineOutputting.tankId.ToString());
                        factory.factoryStorage.SetTankBelt(entityOfMachineOutputting.tankId, lastBeltId, slotOfMachineOutputting, false);
                    }
                    if (entityOfMachineOutputting.fractionateId != 0)
                    {
                        //Logger.LogInfo("      Belt receiving input from fractionator " + entityOfMachineOutputting.fractionateId.ToString());
                        factory.factorySystem.SetFractionateBelt(entityOfMachineOutputting.fractionateId, lastBeltId, slotOfMachineOutputting, false);
                    }
                    if (entityOfMachineOutputting.powerExcId != 0)
                    {
                        //Logger.LogInfo("      Belt receiving input from power exchanger " + entityOfMachineOutputting.powerExcId.ToString());
                        factory.powerSystem.SetExchangerBelt(entityOfMachineOutputting.powerExcId, lastBeltId, slotOfMachineOutputting, false);
                    }
                    if (entityOfMachineOutputting.stationId != 0)
                    {
                        Logger.LogInfo("      Belt receiving input from station " + entityOfMachineOutputting.stationId.ToString());

                        foreach (StationComponent sc in factory.transport.stationPool)
                        {
                            if (sc != null && sc.id != 0)
                            {
                                Logger.LogInfo("      WAS Station " + sc.name);
                                foreach (SlotData s in sc.slots)
                                {
                                    if (s.dir != IODir.None)
                                        Logger.LogInfo("      WAS Slot: dir=" + s.dir.ToString() + ", beltId=" + s.beltId.ToString() + ", counter=" + s.counter.ToString() + ", storageIdx=" + s.storageIdx.ToString());
                                }
                            }
                        }

                        //StationComponent stationComponent = factory.transport.stationPool[entityOfMachineOutputting.stationId];
                        //stationComponent.slots[slotOfMachineOutputting].dir = IODir.Input;
                        //stationComponent.slots[slotOfMachineOutputting].beltId = lastBeltId;
                        //stationComponent.slots[slotOfMachineOutputting].counter = 0;
                        //stationComponent.UpdateIOSlots(cargoTraffic, factory.entitySignPool);

                        int stationEntityId = entityOfMachineOutputting.id;
                        //factory.ApplyEntityDisconnection(stationEntityId, firstBelt.entityId, slotOfMachineOutputting, 0);
                        factory.ApplyEntityInput(stationEntityId, lastBelt.entityId, slotOfMachineOutputting, slotOfMachineOutputting, 0);
                        //factory.ApplyPickTarget(stationEntityId, lastBelt.entityId, slotOfMachineOutputting, 0);

                        foreach (StationComponent sc in factory.transport.stationPool)
                        {
                            if (sc != null && sc.id != 0)
                            {
                                Logger.LogInfo("      IS Station " + sc.name);
                                foreach (SlotData s in sc.slots)
                                {
                                    if (s.dir != IODir.None)
                                        Logger.LogInfo("      IS Slot: dir=" + s.dir.ToString() + ", beltId=" + s.beltId.ToString() + ", counter=" + s.counter.ToString() + ", storageIdx=" + s.storageIdx.ToString());
                                }
                            }
                        }
                    }
                }
                if (entityIdOfMachineGettingInput > 0)
                {
                    EntityData entityOfMachineGettingInput = factory.entityPool[entityIdOfMachineGettingInput];
                    if (entityOfMachineGettingInput.splitterId != 0)
                    {
                        //Logger.LogInfo("      Belt outputting to splitter " + entityOfMachineGettingInput.splitterId.ToString());
                        cargoTraffic.ConnectToSplitter(entityOfMachineGettingInput.splitterId, firstBeltId, slotOfMachineGettingInput, false);
                    }
                    if (entityOfMachineGettingInput.minerId != 0)
                    {
                        //Logger.LogInfo("      ERROR: Belt outputting to miner " + entityOfMachineGettingInput.minerId.ToString());
                    }
                    if (entityOfMachineGettingInput.tankId != 0)
                    {
                        //Logger.LogInfo("      Belt outputting to tank " + entityOfMachineGettingInput.tankId.ToString());
                        factory.factoryStorage.SetTankBelt(entityOfMachineGettingInput.tankId, firstBeltId, slotOfMachineGettingInput, true);
                    }
                    if (entityOfMachineGettingInput.fractionateId != 0)
                    {
                        //Logger.LogInfo("      Belt outputting to fractionator " + entityOfMachineGettingInput.fractionateId.ToString());
                        factory.factorySystem.SetFractionateBelt(entityOfMachineGettingInput.fractionateId, firstBeltId, slotOfMachineGettingInput, true);
                    }
                    if (entityOfMachineGettingInput.powerExcId != 0)
                    {
                        //Logger.LogInfo("      Belt outputting to power exchanger " + entityOfMachineGettingInput.powerExcId.ToString());
                        factory.powerSystem.SetExchangerBelt(entityOfMachineGettingInput.powerExcId, firstBeltId, slotOfMachineGettingInput, true);
                    }
                    if (entityOfMachineGettingInput.stationId != 0)
                    {
                        Logger.LogInfo("      Belt outputting to station " + entityOfMachineGettingInput.stationId.ToString());

                        foreach (StationComponent sc in factory.transport.stationPool)
                        {
                            if (sc != null && sc.id != 0)
                            {
                                Logger.LogInfo("      WAS Station " + sc.name);
                                foreach (SlotData s in sc.slots)
                                {
                                    if (s.dir != IODir.None)
                                        Logger.LogInfo("         WAS Slot: dir=" + s.dir.ToString() + ", beltId=" + s.beltId.ToString() + ", counter=" + s.counter.ToString() + ", storageIdx=" + s.storageIdx.ToString());
                                }
                            }
                        }

                        //StationComponent stationComponent = factory.transport.stationPool[entityOfMachineGettingInput.stationId];
                        //stationComponent.slots[slotOfMachineGettingInput].dir = IODir.Output;
                        //stationComponent.slots[slotOfMachineGettingInput].beltId = firstBeltId;
                        //stationComponent.slots[slotOfMachineGettingInput].counter = 0;
                        //stationComponent.UpdateIOSlots(cargoTraffic, factory.entitySignPool);

                        int stationEntityId = entityOfMachineGettingInput.id;
                        //factory.ApplyEntityDisconnection(stationEntityId, lastBelt.entityId, slotOfMachineGettingInput, 0);
                        factory.ApplyEntityOutput(stationEntityId, firstBelt.entityId, slotOfMachineGettingInput, slotOfMachineGettingInput, 0);
                        //factory.ApplyInsertTarget(stationEntityId, firstBelt.entityId, slotOfMachineGettingInput, 0);

                        foreach (StationComponent sc in factory.transport.stationPool)
                        {
                            if (sc != null && sc.id != 0)
                            {
                                Logger.LogInfo("      IS Station " + sc.name);
                                foreach (SlotData s in sc.slots)
                                {
                                    if (s.dir != IODir.None)
                                        Logger.LogInfo("         IS Slot: dir=" + s.dir.ToString() + ", beltId=" + s.beltId.ToString() + ", counter=" + s.counter.ToString() + ", storageIdx=" + s.storageIdx.ToString());
                                }
                            }
                        }
                    }
                }

                // Audio comes from LDB.audios.  Good built-in choices are "warp-end" or "ui-click-2" (the upgrade sound).
                VFAudio.Create("ui-click-2", null, GameMain.mainPlayer.factory.entityPool[beltComponent.entityId].pos, true);
            }
        }
    }
}
